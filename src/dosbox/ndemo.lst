     1                                  ; Assemble with: nasm -f bin -o ndemo.com ndemo.asm -l ndemo.lst
     2                                  
     3                                      ; 16-bit code
     4                                      BITS 16
     5                                       ; COM programs start at offset 100h
     6                                      ORG 100h
     7                                  
     8                                  start:
     9                                      ; Set video mode (320x200, 256 colors)
    10 00000000 B81300                      mov ax, 0013h
    11 00000003 CD10                        int 10h
    12                                  
    13                                      ; Initialize video memory segment
    14 00000005 B800A0                      mov ax, 0A000h
    15 00000008 8EC0                        mov es, ax
    16                                  
    17                                  main_loop:
    18                                      ; Load sin cos
    19 0000000A DF06[FC00]                  fild word  [time]
    20 0000000E D80E[E400]                  fmul dword [_0_01]
    21 00000012 D9FB                        fsincos
    22 00000014 D91E[0C00]                  fstp dword [cos]
    23 00000018 D91E[0800]                  fstp dword [sin]
    24                                  
    25                                      ; Reset position to start of video memory
    26 0000001C 31FF                        xor di, di
    27                                  
    28 0000001E C706[0200]C800              mov word [y], 200
    29                                  y_loop:
    30 00000024 C706[0000]4001              mov word [x], 320
    31                                  x_loop:
    32 0000002A DF06[0200]                  fild word [y]
    33 0000002E D80E[E400]                  fmul dword [_0_01]
    34 00000032 D9E8                        fld1
    35 00000034 DEE9                        fsub
    36                                  
    37 00000036 DF06[0000]                  fild word [x]
    38 0000003A D80E[E400]                  fmul dword [_0_01]
    39 0000003E D826[E800]                  fsub dword [_1_6]
    40                                  
    41                                      ; Stack
    42                                      ; ST(0) - x
    43                                      ; ST(1) - y
    44                                  
    45 00000042 D9EE                        fldz
    46                                      ; Dupe x/y
    47 00000044 D9C2                        fld  st2
    48 00000046 D9C2                        fld  st2
    49                                  
    50 00000048 B90200                      mov cx, 2
    51                                  a_loop:
    52 0000004B D9C9                        fxch st1
    53 0000004D D80E[EC00]                  fmul dword [_4]
    54 00000051 D9C0                        fld st0
    55 00000053 D9FC                        frndint
    56 00000055 DEE9                        fsubp st1, st0
    57 00000057 D80E[F800]                  fmul dword [_0_25]
    58 0000005B D8C8                        fmul st0
    59 0000005D DCC2                        fadd st2, st0
    60 0000005F E2EA                        loop a_loop
    61                                  
    62 00000061 DDD8                        fstp st0
    63 00000063 DDD8                        fstp st0
    64                                  
    65 00000065 DDDB                        fstp st3
    66                                  
    67 00000067 B90100                      mov cx, 1
    68                                  b_loop:
    69                                      ; Stack
    70                                      ; ST(0) - x
    71                                      ; ST(1) - y
    72                                      ; ST(2) - d
    73                                  
    74                                      ; Add path
    75 0000006A D806[0C00]                  fadd dword [cos]
    76 0000006E D9C9                        fxch
    77 00000070 D806[0800]                  fadd dword [sin]
    78                                  
    79                                      ; dot
    80 00000074 D9EE                        fldz
    81 00000076 D9C1                        fld st1
    82 00000078 D8C8                        fmul st0
    83 0000007A DEC1                        fadd
    84 0000007C D9C2                        fld st2
    85 0000007E D8C8                        fmul st0
    86 00000080 DEC1                        fadd
    87                                  
    88                                      ; ST(0) - td
    89                                      ; ST(1) - x
    90                                      ; ST(2) - y
    91                                      ; ST(3) - d
    92                                  
    93                                      ; k = 1/8
    94                                      ; float pmin(float a, float b, float k) {
    95                                      ;   float h = clamp( 0.5+0.5*(b-a)/k, 0.0, 1.0 );
    96                                      ;   return mix( b, a, h ) - k*h*(1.0-h);
    97                                      ; }
    98                                  
    99                                      ; td-d
   100 00000082 D8E3                        fsub  st3
   101 00000084 D9C0                        fld   st0
   102 00000086 D80E[EC00]                  fmul  dword [_4]
   103 0000008A D806[F000]                  fadd  dword [_0_5]
   104                                  
   105 0000008E D9E8                        fld1
   106 00000090 D8D9                        fcomp
   107 00000092 9BDFE0                      fstsw ax
   108 00000095 9E                          sahf
   109 00000096 7704                        ja .min1
   110 00000098 DDD8                        fstp st0
   111 0000009A D9E8                        fld1
   112                                  .min1:
   113                                  
   114 0000009C D9E8                        fld1
   115 0000009E D8E1                        fsub st0, st1
   116                                  
   117                                      ; Stack
   118                                      ; ST(0) - 1-h
   119                                      ; ST(1) - h
   120                                      ; ST(2) - td-d
   121                                      ; ST(3) - x
   122                                      ; ST(4) - y
   123                                      ; ST(5) - d
   124                                  
   125                                      ; Compute (1-h)*(td-d)
   126 000000A0 D9C0                        fld   st0
   127 000000A2 D8CB                        fmul  st3
   128                                      ; Add it to d (now ST(6)
   129 000000A4 DEC6                        faddp st6, st0
   130                                      ; Compute (1-h)*h*0.125
   131 000000A6 D80E[F400]                  fmul  dword [_0_125]
   132 000000AA DEC9                        fmul
   133                                      ; Subtract from d
   134 000000AC DEEC                        fsubp st4
   135                                  
   136                                      ; Pop td-d
   137 000000AE DDD8                        fstp  st0
   138                                  
   139 000000B0 E2B8                        loop b_loop
   140                                  
   141 000000B2 DDD8                        fstp  st0
   142 000000B4 DDD8                        fstp  st0
   143                                  
   144 000000B6 D9E0                        fchs
   145                                  
   146                                      ; Hacky colors
   147 000000B8 D91E[0400]                  fstp dword [_bits]
   148 000000BC A0[0700]                    mov al, [_bits+3]
   149 000000BF 2C10                        sub al,16
   150                                      ; Write pixel
   151 000000C1 AA                          stosb
   152                                  
   153                                      ; Clean up stack (if not the DosBox dynamic mode fails)
   154                                  
   155 000000C2 FF0E[0000]                  dec word [x]
   156 000000C6 0F8560FF                    jnz x_loop
   157                                  
   158 000000CA FF0E[0200]                  dec word [y]
   159 000000CE 0F8552FF                    jnz y_loop
   160                                  
   161 000000D2 FF06[FC00]                  inc word [time]
   162                                  
   163                                      ; Check for keypress to exit
   164 000000D6 B401                        mov ah, 1
   165 000000D8 CD16                        int 16h
   166 000000DA 0F842CFF                    jz main_loop
   167                                  
   168                                      ; Restore text mode
   169 000000DE B80300                      mov ax, 0x0003
   170 000000E1 CD10                        int 0x10
   171                                  
   172 000000E3 C3                          ret
   173                                  
   174                                  ; Data section
   175 000000E4 0AD7233C                _0_01       dd  0.01
   176 000000E8 CDCCCC3F                _1_6        dd  1.6
   177 000000EC 00008040                _4          dd  4.0
   178 000000F0 0000003F                _0_5        dd  0.5
   179 000000F4 0000003E                _0_125      dd  0.125
   180 000000F8 0000803E                _0_25       dd  0.25
   181                                  
   182 000000FC 0000                    time        dw  0
   183                                  
   184                                  section .bss
   185 00000000 ????                    x           resb 2
   186 00000002 ????                    y           resb 2
   187                                  
   188 00000004 ????????                _bits       resb 4
   189 00000008 ????????                sin         resb 4
   190 0000000C ????????                cos         resb 4
   191                                  
